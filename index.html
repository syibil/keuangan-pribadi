<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Tahunan Abil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Konfigurasi Firebase dari Environment
        const firebaseConfig = {
            apiKey: "AIzaSyAnwD9rvEIughlVk1DIzRxEedIWgZPm4Qk",
            authDomain: "finance-2026-62cce.firebaseapp.com",
            projectId: "finance-2026-62cce",
            storageBucket: "finance-2026-62cce.firebasestorage.app",
            messagingSenderId: "975856393454",
            appId: "1:975856393454:web:ae97bfbfef89862c47e7ff",
            measurementId: "G-ZS5X6JPQEE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const appId = 'keuangan-tahunan-v1';

        let transactions = [];
        let financeChart;
        let currentUser = null;

        const loginArea = document.getElementById('login-area');
        const appArea = document.getElementById('app-area');
        const userDisplay = document.getElementById('user-display');
        const list = document.getElementById('transaction-list');
        const emptyState = document.getElementById('empty-state');
        const monthFilter = document.getElementById('month-filter');

        // Fungsi Login
        window.login = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Error:", error);
                alert("Gagal Login: " + error.message);
            }
        };

        // Fungsi Logout
        window.logout = () => signOut(auth);

        // Pantau Status Login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginArea.classList.add('hidden');
                appArea.classList.remove('hidden');
                userDisplay.innerText = `Halo, ${user.displayName}`;
                setupRealtimeListener(user.uid);
            } else {
                currentUser = null;
                loginArea.classList.remove('hidden');
                appArea.classList.add('hidden');
            }
        });

        function setupRealtimeListener(userId) {
            const q = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                updateUI();
            });
        }

        window.addTransaction = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const data = {
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.querySelector('input[name="type"]:checked').value,
                createdAt: Date.now()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), data);
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
            } catch (error) {
                alert("Gagal simpan: " + error.message);
            }
        };

        window.deleteTransaction = async (id) => {
            if (!currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id));
        };

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        function updateUI() {
            const selectedMonth = monthFilter.value;
            let filtered = [...transactions];
            if (selectedMonth !== 'all') {
                filtered = transactions.filter(t => t.date.split('-')[1] === selectedMonth);
            }
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = '';
            let totalInc = 0; totalExp = 0;

            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filtered.forEach((t) => {
                    if (t.type === 'income') totalInc += t.amount; else totalExp += t.amount;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${t.date}</td>
                        <td class="px-4 py-3 text-sm">${t.category}</td>
                        <td class="px-4 py-3 text-sm font-medium">${t.description}</td>
                        <td class="px-4 py-3 text-sm text-right font-bold ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-400 hover:text-red-600">âœ•</button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            }

            document.getElementById('total-income').innerText = formatCurrency(totalInc);
            document.getElementById('total-expense').innerText = formatCurrency(totalExp);
            document.getElementById('balance').innerText = formatCurrency(totalInc - totalExp);
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthlyInc = new Array(12).fill(0);
            const monthlyExp = new Array(12).fill(0);

            transactions.forEach(t => {
                const monthIdx = parseInt(t.date.split('-')[1]) - 1;
                if (t.type === 'income') monthlyInc[monthIdx] += t.amount; else monthlyExp[monthIdx] += t.amount;
            });

            if (financeChart) financeChart.destroy();
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Masuk', data: monthlyInc, backgroundColor: '#3b82f6' },
                        { label: 'Keluar', data: monthlyExp, backgroundColor: '#ef4444' }
                    ]
                }
            });
        }

        monthFilter.addEventListener('change', updateUI);
        document.getElementById('transaction-form').addEventListener('submit', window.addTransaction);
        document.getElementById('date').valueAsDate = new Date();
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- TAMPILAN LOGIN -->
    <div id="login-area" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Buku Kas Online Abil</h1>
            <p class="text-gray-500 mb-8">Pakai akun Google ya! buat simpen data otomatis di semua perangkat. anjay!</p>
            <button onclick="login()" class="flex items-center justify-center w-full bg-white border border-gray-300 py-2 px-4 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-3">
                Masuk pakai Google ya!
            </button>
        </div>
    </div>

    <!-- TAMPILAN APLIKASI -->
    <div id="app-area" class="hidden max-w-6xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Catatan Keuangan</h1>
                <p id="user-display" class="text-sm text-blue-600 font-medium"></p>
            </div>
            <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500">Keluar</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-xs text-gray-500 uppercase">Pemasukan</p>
                <p id="total-income" class="text-xl font-bold text-blue-600">Rp 0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-xs text-gray-500 uppercase">Pengeluaran</p>
                <p id="total-expense" class="text-xl font-bold text-red-600">Rp 0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-xs text-gray-500 uppercase">Saldo</p>
                <p id="balance" class="text-xl font-bold text-gray-800">Rp 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4">Transaksi Baru</h3>
                <form id="transaction-form" class="space-y-4">
                    <input type="date" id="date" required class="w-full p-2 border rounded-lg">
                    <input type="text" id="description" placeholder="Keterangan" required class="w-full p-2 border rounded-lg">
                    <select id="category" class="w-full p-2 border rounded-lg">
                            <option>FOOD</option>
                            <option>DRINK</option>
                            <option>RENT</option>
                            <option>BEAUTY</option>
                            <option>HEALTH</option>
                            <option>INTERNET</option>
                            <option>TRANSPORT</option>
                            <option>ENTERTAIN</option>
                            <option>CLOTHES</option>
                            <option>EDUCATION</option>
                            <option>GAJI POKOK</option>
                            <option>FREELANCE</option>
                            <option>TRF</option>
                            <option>LAIN - LAIN</option>
                            <option>SEDEKAH</option>
                    </select>
                    <div class="flex gap-4 p-2 bg-gray-50 rounded-lg">
                        <label class="flex-1 text-center"><input type="radio" name="type" value="income"> Masuk</label>
                        <label class="flex-1 text-center"><input type="radio" name="type" value="expense" checked> Keluar</label>
                    </div>
                    <input type="number" id="amount" placeholder="Jumlah Rp" required class="w-full p-2 border rounded-lg">
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Simpan</button>
                </form>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                    <canvas id="financeChart" height="100"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <span class="font-bold">Riwayat</span>
                        <select id="month-filter" class="text-sm border rounded p-1">
                            <option value="all">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option>
                            <option value="03">Maret</option><option value="04">April</option>
                            <option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option>
                            <option value="09">September</option><option value="10">Oktober</option>
                            <option value="11">November</option><option value="12">Desember</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-left">
                            <tbody id="transaction-list"></tbody>
                        </table>
                        <div id="empty-state" class="p-8 text-center text-gray-400">Belum ada data.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>