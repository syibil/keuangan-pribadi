<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Abil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Konfigurasi Firebase dari Environment
        const firebaseConfig = {
            apiKey: "AIzaSyAnwD9rvEIughlVk1DIzRxEedIWgZPm4Qk",
            authDomain: "finance-2026-62cce.firebaseapp.com",
            projectId: "finance-2026-62cce",
            storageBucket: "finance-2026-62cce.firebasestorage.app",
            messagingSenderId: "975856393454",
            appId: "1:975856393454:web:ae97bfbfef89862c47e7ff",
            measurementId: "G-ZS5X6JPQEE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        // Menambahkan parameter agar popup tidak terblokir di beberapa browser
        provider.setCustomParameters({ prompt: 'select_account' });
        
        const appId = 'keuangan-tahunan-v1';

        let transactions = [];
        let financeChart;
        let currentUser = null;

        const loginArea = document.getElementById('login-area');
        const appArea = document.getElementById('app-area');
        const userDisplay = document.getElementById('user-display');
        const list = document.getElementById('transaction-list');
        const emptyState = document.getElementById('empty-state');
        const monthFilter = document.getElementById('month-filter');

        window.login = async () => {
    try {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Gunakan localStorage karena Safari mobile sering membersihkan sessionStorage saat redirect
        localStorage.setItem('pendingLogin', 'true');
        
        await setPersistence(auth, browserLocalPersistence);
        
        if (isMobile) {
            console.log("Memulai login redirect untuk mobile... ☺️");
            await signInWithRedirect(auth, provider);
        } else {
            await signInWithPopup(auth, provider);
        }
    } catch (error) {
        localStorage.removeItem('pendingLogin');
        console.error("Login Error:", error);
        if (error.code === 'auth/user-disabled') {
            alert("Masa aktif akun Anda telah berakhir. Hubungi instagram @slipknotcrochet_ untuk Berlangganan");
        } else if (error.code !== 'auth/cancelled-popup-request' && error.code !== 'auth/popup-closed-by-user') {
            alert("Gagal Login: " + error.message);
        }
    }
};

window.logout = () => {
    localStorage.removeItem('pendingLogin');
    signOut(auth);
};

// Listener Status Login dengan Proteksi Sesi Safari
onAuthStateChanged(auth, async (user) => {
    // Jika ada user, bersihkan status dan masuk ke aplikasi
    if (user) {
        localStorage.removeItem('pendingLogin');
        try {
            await user.getIdToken(true);
            currentUser = user;
            loginArea.classList.add('hidden');
            appArea.classList.remove('hidden');
            userDisplay.innerText = `Halo, ${user.displayName}`;
            setupRealtimeListener(user.uid);
        } catch (error) {
            if (error.code === 'auth/user-disabled') {
                alert("Akun dinonaktifkan. Hubungi instagram @slipknotcrochet_ untuk Berlangganan");
                signOut(auth);
            }
        }
        return;
    }

    // Jika tidak ada user, cek apakah baru kembali dari Redirect
    try {
        const result = await getRedirectResult(auth);
        if (result && result.user) {
            localStorage.removeItem('pendingLogin');
            return; 
        }
    } catch (error) {
        localStorage.removeItem('pendingLogin');
        if (error.code === 'auth/user-disabled') {
            alert("Akun dinonaktifkan. Hubungi instagram @slipknotcrochet_ untuk Berlangganan");
        }
    }

    // Solusi Safari: Berikan jeda 1 detik sebelum memunculkan tombol login
    // Ini memberi waktu bagi Firebase untuk 'mengenali' user setelah redirect
    setTimeout(() => {
        if (!auth.currentUser && !localStorage.getItem('pendingLogin')) {
            currentUser = null;
            loginArea.classList.remove('hidden');
            appArea.classList.add('hidden');
        } else {
            console.log("Menunggu sinkronisasi...");
        }
    }, 1000);
});
        function setupRealtimeListener(userId) {
            const q = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                updateUI();
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        }

        window.addTransaction = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const data = {
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.querySelector('input[name="type"]:checked').value,
                createdAt: Date.now()
            };

            try {
                const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
                await addDoc(colRef, data);
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
            } catch (error) {
                console.error("Save Error:", error);
                alert("Gagal menyimpan: " + error.message);
            }
        };

        window.deleteTransaction = async (id) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id));
            } catch (error) {
                alert("Gagal menghapus");
            }
        };

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        function updateUI() {
            const selectedMonth = monthFilter.value;
            let filtered = [...transactions];
            if (selectedMonth !== 'all') {
                filtered = transactions.filter(t => t.date.split('-')[1] === selectedMonth);
            }
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = '';
            // PERBAIKAN: Deklarasi variabel totalInc dan totalExp yang benar
            let totalInc = 0; 
            let totalExp = 0;

            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filtered.forEach((t) => {
                    if (t.type === 'income') {
                        totalInc += t.amount;
                    } else {
                        totalExp += t.amount;
                    }
                    
                    const row = document.createElement('tr');
                    row.className = "border-b hover:bg-gray-50 transition";
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-600">${t.date}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 font-bold">${t.category}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-800">${t.description}</td>
                        <td class="px-4 py-3 text-sm text-right font-bold ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-400 hover:text-red-600 transition">✕</button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            }

            document.getElementById('total-income').innerText = formatCurrency(totalInc);
            document.getElementById('total-expense').innerText = formatCurrency(totalExp);
            document.getElementById('balance').innerText = formatCurrency(totalInc - totalExp);
            updateChart();
        }

        function updateChart() {
            const canvas = document.getElementById('financeChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthlyInc = new Array(12).fill(0);
            const monthlyExp = new Array(12).fill(0);

            transactions.forEach(t => {
                const monthIdx = parseInt(t.date.split('-')[1]) - 1;
                if (t.type === 'income') monthlyInc[monthIdx] += t.amount; else monthlyExp[monthIdx] += t.amount;
            });

            if (financeChart) financeChart.destroy();
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'Masuk', data: monthlyInc, backgroundColor: '#3b82f6' },
                        { label: 'Keluar', data: monthlyExp, backgroundColor: '#ef4444' }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        monthFilter.addEventListener('change', updateUI);
        document.getElementById('transaction-form').addEventListener('submit', window.addTransaction);
        document.getElementById('date').valueAsDate = new Date();
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <!-- TAMPILAN LOGIN -->
    <div id="login-area" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
            <h1 class="text-2xl font-bold mb-6 text-gray-800">Buku Kas Online Subs</h1>
            <p class="text-gray-500 mb-8">Pakai akun Google ya! buat simpen data otomatis di semua perangkat. anjay!</p>
            <button onclick="login()" class="flex items-center justify-center w-full bg-white border border-gray-300 py-2 px-4 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-3">
                Masuk pakai Google ya!
            </button>
        </div>
    </div>

    <!-- LAYAR APLIKASI -->
    <div id="app-area" class="hidden max-w-6xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm">
            <div>
                <h1 id="user-display" class="font-black text-xl text-gray-800"></h1>
                <p class="text-xs text-blue-500 font-bold">Cloud Synced & Protected</p>
            </div>
            <button onclick="logout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-100 transition">Keluar</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-8 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Pemasukan</p>
                <p id="total-income" class="text-2xl font-black text-blue-600 tracking-tight">Rp 0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-8 border-red-500">
                <p class="text-xs font-bold text-gray-400 uppercase">Pengeluaran</p>
                <p id="total-expense" class="text-2xl font-black text-red-600 tracking-tight">Rp 0</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-8 border-gray-800">
                <p class="text-xs font-bold text-gray-400 uppercase">Saldo</p>
                <p id="balance" class="text-2xl font-black text-gray-800 tracking-tight">Rp 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-8 rounded-3xl shadow-sm h-fit">
                <h3 class="font-black text-lg mb-6 text-gray-800 uppercase tracking-tight">Tambah Baru</h3>
                <form id="transaction-form" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Tanggal</label>
                        <input type="date" id="date" required class="w-full p-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Deskripsi</label>
                        <input type="text" id="description" placeholder="Contoh: Belanja Bulanan" required class="w-full p-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Kategori</label>
                        <select id="category" class="w-full p-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                            <option>FOOD</option>
                            <option>DRINK</option>
                            <option>BELANJA BULANAN</option>
                            <option>RENT</option>
                            <option>BEAUTY</option>
                            <option>HEALTH</option>
                            <option>INTERNET</option>
                            <option>TRANSPORT</option>
                            <option>ENTERTAIN</option>
                            <option>CLOTHES</option>
                            <option>EDUCATION</option>
                            <option>DIGITAL SUBS (game, apps, netflix)</option>
                            <option>GAJI POKOK</option>
                            <option>FREELANCE</option>
                            <option>INVEST</option>
                            <option>LAIN - LAIN</option>
                            <option>SEDEKAH</option>
                        </select>
                    </div>
                    <div class="flex gap-2 p-1 bg-gray-50 rounded-2xl">
                        <label class="flex-1">
                            <input type="radio" name="type" value="income" class="hidden peer">
                            <div class="text-center py-2 rounded-xl cursor-pointer peer-checked:bg-white peer-checked:shadow-sm text-gray-400 peer-checked:text-blue-600 font-black text-xs transition-all uppercase">Masuk</div>
                        </label>
                        <label class="flex-1">
                            <input type="radio" name="type" value="expense" checked class="hidden peer">
                            <div class="text-center py-2 rounded-xl cursor-pointer peer-checked:bg-white peer-checked:shadow-sm text-gray-400 peer-checked:text-red-600 font-black text-xs transition-all uppercase">Keluar</div>
                        </label>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-1">Jumlah (Rp)</label>
                        <input type="number" id="amount" placeholder="0" required class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-black text-xl">
                    </div>
                    <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black hover:bg-black transition-all shadow-lg mt-4 uppercase tracking-widest text-sm">Simpan</button>
                </form>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm h-64">
                    <canvas id="financeChart"></canvas>
                </div>
                <div class="bg-white rounded-3xl shadow-sm overflow-hidden">
                    <div class="p-6 bg-gray-50/50 border-b flex justify-between items-center">
                        <span class="font-black text-gray-800 uppercase tracking-tight">Riwayat Transaksi</span>
                        <select id="month-filter" class="text-xs border-none bg-white font-bold rounded-xl p-2 shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">Semua Bulan</option>
                            <option value="01">Januari</option><option value="02">Februari</option>
                            <option value="03">Maret</option><option value="04">April</option>
                            <option value="05">Mei</option><option value="06">Juni</option>
                            <option value="07">Juli</option><option value="08">Agustus</option>
                            <option value="09">September</option><option value="10">Oktober</option>
                            <option value="11">November</option><option value="12">Desember</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <tbody id="transaction-list" class="divide-y divide-gray-50"></tbody>
                        </table>
                        <div id="empty-state" class="p-20 text-center">
                            <p class="text-gray-300 font-black uppercase tracking-widest text-xs">Belum ada data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
